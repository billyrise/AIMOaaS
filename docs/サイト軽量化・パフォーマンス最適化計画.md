# サイト軽量化・パフォーマンス最適化計画

**目的**: 表示パフォーマンスを世界最速レベルに近づけるため、サイト全体の分析結果と実施可能な最適化を優先度付きで整理する。  
**前提**: サイトは Cloudflare Pages にホストされている（エッジ配信・キャッシュは有利。ビルド成果物の軽さがそのまま効く）。

---

## 1. 現状分析サマリ

### 1.1 ページ種別とアセット

| 種別 | ページ数目安 | 共通点 | 差分 |
|------|--------------|--------|------|
| **PSEO（監査・証跡）** | 約90 | 同一テンプレート `templates/pseo/page.html` | 本文・メタのみ |
| **ランディング（言語別 index）** | ja, en, de, es, fr, it, ko, pt, zh-CN, zh-TW 等 | Tailwind CDN + Google Fonts + 大きなインラインCSS | 言語・フォント・Lucide の有無 |
| **リソース / aimo-standard 等** | 多数 | ランディングに近い構成の可能性 | 要個別確認 |
| **404** | 1 | Tailwind CDN + Inter フォント | 最小構成 |

### 1.2 CSS の扱い（共通化の観点）

- **プロジェクト内に `.css` ファイルは存在しない。**
- スタイルの出所は次のみ:
  1. **Tailwind CDN** (`https://cdn.tailwindcss.com`) … 全ページで読み込み
  2. **Google Fonts** … 言語ごとに Noto Sans JP / Inter 等
  3. **インライン `<style>`**
     - PSEO: テンプレート由来の約15行（表・prose 用）→ 共通化済み（テンプレート1本）
     - ランディング: 70行超のブロックが **各言語の index.html に重複**（hero、モバイルメニュー、glass-card 等）→ **共通化されていない**

**結論**: 共通化されるべきもののうち、PSEO 用の最小 CSS はテンプレートで一元化されているが、**ランディング用の大きなインライン CSS は言語・ページごとにコピーされており共通化されていない**。また **Tailwind は CDN のまま**で、ビルド済み CSS に置き換えられていない。

### 1.3 JavaScript

- **Tailwind CDN**: `<script src="https://cdn.tailwindcss.com"></script>`  
  - ランタイムで DOM をスキャンし CSS を生成するため、**初回表示が重い・レンダリングブロック要因**。
- **Lucide アイコン**: ランディング系で `https://unpkg.com/lucide@latest` + `lucide.createIcons()`  
  - フッター直前で読み込み。`defer` 等は未使用。
- その他: モバイルメニュー開閉等のインラインスクリプト（軽微）。

### 1.4 フォント

- **Google Fonts** をスタイルシートで取得（preconnect はあり）。
- 日本語: `Noto Sans JP` (400,500,700 等)、英語: `Inter`。
- `display=swap` 指定あり → FOUT は許容されているが、**サブセット化・セルフホスト・preload は未実施**。

### 1.5 画像

- **assets/**
  - `aimo-standard-unifying-regulations.png` … 約 93KB
  - `ogp-default.png` … 約 146KB
- OGP/ヒーローで共通利用。**WebP/AVIF 化・レスポンシブ `srcset`・`loading="lazy"` の明示**は未確認。

### 1.6 その他

- **preload / prefetch**: 未使用。
- **Critical CSS**: インラインはあるが、Above-the-fold に限定した抽出はしていない。
- **HTTP キャッシュ**: Cloudflare 任せの想定。Cache-Control や immutable の明示は未確認。

---

## 2. 問題の整理（優先度の根拠）

| 問題 | 影響 | 共通化の観点 |
|------|------|----------------|
| Tailwind を CDN のまま使用 | 毎ページで ~150KB+ の JS を実行し、その結果として CSS を生成。LCP・FCP を悪化させやすい | 共通ビルド CSS にすれば全ページで1ファイル・キャッシュ共有可能 |
| ランディングのインライン CSS 重複 | 各言語 index に 70行超の同一 CSS がコピー。HTML 肥大・キャッシュ効率悪化 | 1本の共通 CSS ファイルにまとめればキャッシュ効率が劇的向上 |
| Google Fonts をそのまま取得 | 外部ラウンドトリップ・レンダーブロックの可能性 | サブセット・セルフホストで同一オリジン化すればキャッシュ・制御が効く |
| フォント・キーリソースに preload なし | 重要リソースの優先取得がされない | 共通 head で preload を1か所管理可能 |
| Lucide を `@latest` で取得 | キャッシュ不安定・サイズ不明 | バージョン固定 + 必要アイコンのみバンドルすれば軽量化 |
| 画像が PNG のまま・最適化未確認 | 帯域・LCP に影響 | 共通画像は WebP/AVIF + srcset で配信すれば全ページで恩恵 |
| スクリプトに defer 未使用 | パース・実行が描画をブロックしうる | 共通テンプレートで defer を付与すれば一括改善 |

---

## 3. 最適化計画（優先度順）

### Phase 1: 即効性が高く、共通化で全ページに効くもの

1. **Tailwind をビルド済み CSS に置き換え（最重要）**
   - 現状: 全ページで `cdn.tailwindcss.com` を読み込み、ランタイムで CSS 生成。
   - 対応:
     - プロジェクトルート（または `scripts/` 配下）に Tailwind を導入し、**使用しているユーティリティのみ**をスキャンして 1 本の CSS にビルドする。
     - 出力例: `assets/css/main.css`（または `assets/css/tailwind.css`）。
   - テンプレート・全 HTML で:
     - `<script src="https://cdn.tailwindcss.com"></script>` を削除。
     - `<link rel="stylesheet" href="/assets/css/main.css">` に統一（パスはルート相対で共通化）。
   - 効果: 初回表示の JS 実行削減・CSS の即時適用・同一 URL でキャッシュ共有。**世界最速を狙うなら必須**。

2. **ランディング用インライン CSS の共通ファイル化**
   - 現状: 各言語の `index.html`（および aimo-standard 等）に、hero・モバイルメニュー・glass-card 等の同じスタイルが 70 行以上ずつ重複。
   - 対応:
     - 共通スタイルを `assets/css/landing.css`（または `main.css` に含める）に切り出し、ランディング系ページからは `<link rel="stylesheet" href="/assets/css/landing.css">` で参照。
     - 既存インライン `<style>` は削除（または Critical のみ残す場合は最小限に）。
   - 効果: HTML サイズ削減・同一 CSS でキャッシュ共有・メンテナンス性向上。

3. **キーリソースの preload**
   - フォント（使用する woff2）と、LCP に関わる CSS に対して:
     - `<link rel="preload" href="..." as="font" type="font/woff2" crossorigin>` および
     - `<link rel="preload" href="/assets/css/main.css" as="style">`
   - 共通 head を持つテンプレートまたは partial で 1 か所だけ管理すると、全ページで一貫して適用される。

4. **Lucide の軽量化**
   - 現状: `unpkg.com/lucide@latest` で全アイコンライブラリを読み込み。
   - 対応:
     - 使用アイコンのみをリストアップし、ビルド時に SVG スプライトまたはインライン SVG にまとめる（または lucide の tree-shake 可能なバンドルを利用し、バージョン固定で自前ホスト）。
   - 効果: スクリプトサイズ削減・キャッシュの安定化。

### Phase 2: フォント・画像の最適化

5. **Google Fonts の最適化**
   - サブセット化: 日本語は「よく使う漢字」または「ページで使う文字」に限定したサブセットを取得。
   - セルフホスト: woff2 を `assets/fonts/` に配置し、`@font-face` で同一オリジンから配信。preload と組み合わせる。
   - 効果: 外部依存削減・レイテンシ削減・キャッシュの確実なヒット。

6. **画像の最適化**
   - `aimo-standard-unifying-regulations.png` / `ogp-default.png`:
     - WebP（および必要なら AVIF）に変換し、`<picture>` または `srcset` で配信。
     - OGP 用は SNS クローラ向けに従来 PNG を fallback してもよい。
   - LCP 画像には `fetchpriority="high"`、それ以外には `loading="lazy"` を明示。
   - 効果: 帯域削減・LCP 改善。

7. **スクリプトの defer**
   - ランディングの `lucide` 等、描画をブロックしないスクリプトには `defer` を付与（またはアイコンを SVG に置き換えればスクリプト自体を削除可能）。

### Phase 3: インフラ・配信の最大化（Cloudflare 活用）

8. **Cache-Control の明示**
   - 静的アセット（CSS/JS/フォント/画像）に長期キャッシュを付与（例: `max-age=31536000, immutable`）。Cloudflare Pages では `_headers` や `cf-worker` で制御可能。
   - HTML は `no-cache` または短い max-age で再検証可能にし、アセットは immutable でキャッシュ。

9. **Critical CSS（オプション）**
   - Above-the-fold 用のごく短い CSS をインラインし、メインの `main.css` は非同期読み込み（`media="print" onload="this.media='all'"` 等）にする手法。Tailwind をビルド済みにしたうえで、さらに FCP を数 ms 単位で詰めたい場合に検討。

10. **PSEO テンプレートの CSS 参照統一**
    - PSEO ページも、Tailwind ビルド後は同じ `main.css` を参照する形にし、現在の「Tailwind CDN + 短いインライン」を「main.css + 必要ならページ固有のごく短いインライン」に整理。これで PSEO も共通キャッシュの恩恵を受ける。

---

## 4. 共通化チェックリスト（実施後）

- [ ] **CSS**: 全ページが `/assets/css/main.css`（および必要なら `landing.css`）を参照し、同一 URL でキャッシュされる。
- [ ] **Tailwind**: CDN はどこにも残っておらず、ビルド済み CSS のみを使用している。
- [ ] **ランディング用スタイル**: インラインの大量重複がなく、1 本の共通ファイルにまとまっている。
- [ ] **フォント**: サブセット・セルフホストの有無にかかわらず、preload と一貫した `@font-face` で管理されている。
- [ ] **JS**: 外部スクリプトはバージョン固定・必要最小限・defer 付与。
- [ ] **画像**: 主要画像は WebP/AVIF と `srcset`/`loading`/`fetchpriority` が適切に設定されている。
- [ ] **キャッシュ**: 静的アセットに長期キャッシュ（immutable）が設定されている。

---

## 5. 技術メモ（実装時の参照）

- **Tailwind ビルド**: `content: ["./ja/**/*.html", "./**/*.html", "./templates/**/*.html"]` のように、全 HTML をスキャン対象に含める。Purge 後は 10〜30KB 程度に収まることが多い。
- **Cloudflare Pages**: ビルドコマンドで `npx tailwindcss -i ./src/input.css -o ./dist/assets/css/main.css` のように出力先を `dist` または公開ルートの `assets/css/` に合わせる。`prepare-deploy.sh` で `assets` をコピーしているため、ビルド成果物を `assets/css/` に出力するか、コピー対象に含めるとよい。
- **フォント**: Google Fonts の「Embed」で表示される URL から woff2 を取得し、`assets/fonts/` に保存。`@font-face` の `font-display: swap` を維持する。

---

## 6. まとめ

- **共通化の観点**: 現状、**共通化されているのは PSEO の「テンプレート由来の短いインライン CSS」のみ**。Tailwind は CDN のため「共通」ではあるが重く、ランディング用の大きなインライン CSS は**共通化されていない**。
- **世界最速レベルを狙うなら**: Phase 1 の「Tailwind をビルド済み CSS に置き換え」と「ランディング用 CSS の共通ファイル化」を最優先で実施し、そのうえでフォント preload・画像最適化・キャッシュの明示を行うと、Cloudflare のエッジと相まって大きな改善が期待できる。

このドキュメントは、上記を実施したあとでも「何を共通化したか」「何がまだページ別か」を確認するためのチェックリストとして更新していくことを推奨する。

---

## 7. 実施済み（Phase 1・2026年2月）

SEO にマイナスにならない範囲で Phase 1 をすべて実施した。

- **Tailwind をビルド済み CSS に置き換え**
  - ルートに `package.json` / `tailwind.config.js` / `src/input.css` を追加。`npm run build:css` で `assets/css/main.css` を生成。
  - 全 HTML から `cdn.tailwindcss.com` の script を削除し、`<link rel="preload" href="/assets/css/main.css" as="style" />` と `<link rel="stylesheet" href="/assets/css/main.css" />` に統一。
- **ランディング用インライン CSS の共通ファイル化**
  - `assets/css/landing.css` に hero・モバイルメニュー・glass-card 等を集約。各ランディング・リソースページではフォント用の 1 行インラインのみ残し、`landing.css` を参照。
- **キーリソースの preload**
  - 全ページで `main.css`（およびランディング系では `landing.css`）に `rel="preload" as="style"` を付与。フォントは従来どおり `preconnect` を維持。
- **Lucide の軽量化**
  - `unpkg.com/lucide@latest` をやめ、バージョン固定の UMD を `scripts/fetch-lucide.js` で取得し `assets/js/lucide.min.js` に保存。全ページで `<script src="/assets/js/lucide.min.js" defer></script>` に統一。

**デプロイ前のローカル作業**

- **CSS のビルド**: `npm run build`（または `npm run build:css`）で `assets/css/main.css` を生成する。これを実行しないとスタイルが反映されない。
- **Lucide**: `assets/js/lucide.min.js` はリポジトリに含めておく想定。バージョンアップ時は `npm run fetch:lucide` で再取得し、コミットする。

**配信物**

- `scripts/prepare-deploy.sh` は `assets` をそのまま `dist/` にコピーするため、`assets/css/` と `assets/js/` は既にデプロイ対象になっている。ビルドで生成した `main.css` と取得済みの `lucide.min.js` もここに含まれる。

**Cloudflare Pages のビルド設定**

デプロイ前に `npm install` と `npm run build` を実行するようにする。

- **ビルドコマンド**: `npm install && npm run build && ./scripts/prepare-deploy.sh`  
  （`dist/` を公開する場合。ルートをそのまま公開する場合は `npm install && npm run build` のみ。）
- **ビルド出力ディレクトリ**: `dist`（`prepare-deploy.sh` を使う場合）。ルートを公開する場合は `/`。
- これにより、毎回デプロイ時に `main.css` が再生成され、`assets` ごと `dist` にコピーされて配信される。
