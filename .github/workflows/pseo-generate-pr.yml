# PSEO: 生成 → 検証 → sitemap 更新 → PR 作成のみ。main への直接 push は禁止。公開は human approval 必須。
#
# 必要な Secrets（リポジトリの Settings → Secrets and variables → Actions で追加）:
#   - GH_TOKEN:    PR 作成・ブランチ push 用。GitHub → Settings → Developer settings → Personal access tokens で
#                 repo + workflow スコープの PAT を発行し、値を登録。未設定だと Checkout で "token" エラーになる。
#   - GOOGLE_API_KEY: Gemini API キー（記事生成に必須）。https://aistudio.google.com/apikey で発行。
#   - CF_ZONE_ID, CF_API_TOKEN: （任意）Cloudflare Analytics 用。未設定でも analytics-pull はスキップされる。
#
name: PSEO Generate PR

# 自動実行は無効。手動で「Run workflow」するときだけ実行。
on:
  workflow_dispatch: {}

env:
  TZ: Asia/Tokyo

jobs:
  generate-and-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # GH_TOKEN 未設定時は default GITHUB_TOKEN を使用（PR 作成は可能。push が制限される場合あり）
          token: ${{ secrets.GH_TOKEN || github.token }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        working-directory: scripts/pseo
        run: |
          if [ -f package-lock.json ]; then npm ci; else npm install; fi

      - name: Generate PSEO pages
        working-directory: scripts/pseo
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          BASE_URL: https://aimoaas.com
        run: npm run generate

      - name: Validate
        working-directory: scripts/pseo
        run: npm run validate

      - name: Update sitemap
        working-directory: scripts/pseo
        env:
          BASE_URL: https://aimoaas.com
        run: npm run sitemap

      - name: Pull analytics (optional) and prioritize
        working-directory: scripts/pseo
        env:
          CF_ZONE_ID: ${{ secrets.CF_ZONE_ID }}
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          PSEO_ANALYTICS_DAYS: "28"
        run: |
          npm run analytics-pull 2>/dev/null || true
          npm run prioritize

      - name: Check for changes
        id: changes
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Create branch and PR
        if: steps.changes.outputs.has_changes == 'true'
        run: |
          BRANCH="chore/pseo-$(date +%Y%m%d)"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH"
          git add ja/resources/pseo/ sitemap.xml
          if git diff --staged --quiet; then
            echo "No staged changes (e.g. only report); skip commit."
            exit 0
          fi
          git commit -m "chore(pseo): generate pages and update sitemap [${BRANCH}]"
          git push origin "$BRANCH"
          {
            echo "PSEO 生成・validate 済み。**main への merge は human approval 後に手動で行ってください。** 公開の責任主体は承認者にあります。"
            if [ -f data/pseo/prioritize-report.md ]; then
              echo ""
              cat data/pseo/prioritize-report.md
            fi
          } > pr_body.md
          gh pr create \
            --base main \
            --head "$BRANCH" \
            --title "chore(pseo): 生成ページ・sitemap 更新 $(date +%Y-%m-%d)" \
            --body-file pr_body.md
